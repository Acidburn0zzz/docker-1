<!DOCTYPE html>
<html>
<head>
  <title>main.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../doc-style.css" />
  <script src="../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = '../../../../../../', thisFile = 'node_modules/watchr/node_modules/bal-util/node_modules/request/main.js';
  </script>
  <script src="../../../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>main.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<p>Copyright 2010-2012 Mikeal Rogers</p>

<p>Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at</p>


<div class="highlight"><pre><code>   <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="n">licenses</span><span class="o">/</span><span class="n">LICENSE</span><span class="o">-</span>2<span class="p">.</span>0
</code></pre></div>



<p>Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">https</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">,</span> <span class="nx">tls</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">,</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;stream&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">qs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;querystring&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">mimetypes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./mimetypes&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">oauth</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./oauth&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./uuid&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">ForeverAgent</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./forever&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Cookie</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./vendor/cookie&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">CookieJar</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./vendor/cookie/jar&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">cookieJar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CookieJar</span>
  <span class="p">,</span> <span class="nx">tunnel</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./tunnel&#39;</span><span class="p">)</span>
  <span class="p">;</span>
  
<span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">logging</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">logging</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">)</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="nx">tls</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;tls&#39;</span><span class="p">)</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>

<span class="kd">function</span> <span class="nx">toBase64</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">str</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">)).</span><span class="nx">toString</span><span class="p">(</span><span class="s2">&quot;base64&quot;</span><span class="p">)</span>
<span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>Hacky fix for pre-0.4.4 https</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">https</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">https</span><span class="p">.</span><span class="nx">Agent</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">https</span><span class="p">.</span><span class="nx">Agent</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">Agent</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">https</span><span class="p">.</span><span class="nx">Agent</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Agent</span><span class="p">)</span>
  <span class="nx">https</span><span class="p">.</span><span class="nx">Agent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_getConnection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">tls</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>do other checks here?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="nx">cb</span><span class="p">()</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="nx">s</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">isReadStream</span> <span class="p">(</span><span class="nx">rs</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">rs</span><span class="p">.</span><span class="nx">readable</span> <span class="o">&amp;&amp;</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">path</span> <span class="o">&amp;&amp;</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">copy</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">o</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
  <span class="p">})</span>
  <span class="k">return</span> <span class="nx">o</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">isUrl</span> <span class="o">=</span> <span class="sr">/^https?:/</span>

<span class="kd">var</span> <span class="nx">globalPool</span> <span class="o">=</span> <span class="p">{}</span>

<span class="kd">function</span> <span class="nx">Request</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">stream</span><span class="p">.</span><span class="nx">Stream</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">readable</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">writable</span> <span class="o">=</span> <span class="kc">true</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span><span class="nx">uri</span><span class="o">:</span><span class="nx">options</span><span class="p">}</span>
  <span class="p">}</span>
  
  <span class="kd">var</span> <span class="nx">reserved</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">reserved</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">options</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">copy</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">Stream</span><span class="p">)</span>
<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">)</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">pool</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">pool</span> <span class="o">=</span> <span class="nx">globalPool</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">dests</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">__isRequestRequest</span> <span class="o">=</span> <span class="kc">true</span>
  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Protect against double callback</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">_callback</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">_callback</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">callback</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">callback</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_callbackCalled</span><span class="p">)</span> <span class="k">return</span> <span class="c1">// Print a warning maybe?</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">_callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">_callbackCalled</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">bind</span><span class="p">())</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;complete&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">callback</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="kc">null</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>People use this property instead all the time so why not just support it.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">url</span>
    <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">url</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;options.uri is a required argument&quot;</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span><span class="p">)</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>do the HTTP CONNECT dance using koichik/node-tunnel</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">globalAgent</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s2">&quot;https:&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">tunnel</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="kd">var</span> <span class="nx">tunnelFn</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s2">&quot;http:&quot;</span>
                   <span class="o">?</span> <span class="nx">tunnel</span><span class="p">.</span><span class="nx">httpsOverHttp</span> <span class="o">:</span> <span class="nx">tunnel</span><span class="p">.</span><span class="nx">httpsOverHttps</span>

      <span class="kd">var</span> <span class="nx">tunnelOptions</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">proxy</span><span class="o">:</span> <span class="p">{</span> <span class="nx">host</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">hostname</span>
                                   <span class="p">,</span> <span class="nx">port</span><span class="o">:</span> <span class="o">+</span><span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">port</span> 
                                   <span class="p">,</span> <span class="nx">proxyAuth</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">auth</span> <span class="p">}</span>
                          <span class="p">,</span> <span class="nx">ca</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">ca</span> <span class="p">}</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">agent</span> <span class="o">=</span> <span class="nx">tunnelFn</span><span class="p">(</span><span class="nx">tunnelOptions</span><span class="p">)</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">tunnel</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">_redirectsFollowed</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_redirectsFollowed</span> <span class="o">||</span> <span class="mi">0</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">maxRedirects</span> <span class="o">=</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">maxRedirects</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">self</span><span class="p">.</span><span class="nx">maxRedirects</span> <span class="o">:</span> <span class="mi">10</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">followRedirect</span> <span class="o">=</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">followRedirect</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">self</span><span class="p">.</span><span class="nx">followRedirect</span> <span class="o">:</span> <span class="kc">true</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">followAllRedirects</span> <span class="o">=</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">followAllRedirects</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="o">?</span> <span class="nx">self</span><span class="p">.</span><span class="nx">followAllRedirects</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">followRedirect</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">followAllRedirects</span><span class="p">)</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">redirects</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">redirects</span> <span class="o">||</span> <span class="p">[]</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span> <span class="o">?</span> <span class="nx">copy</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span> <span class="o">:</span> <span class="p">{}</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">setHost</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">hostname</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">port</span> <span class="o">===</span> <span class="mi">80</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s1">&#39;http:&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
           <span class="o">!</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">port</span> <span class="o">===</span> <span class="mi">443</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="s1">&#39;https:&#39;</span><span class="p">)</span> <span class="p">)</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">port</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">setHost</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">}</span>
  
  <span class="nx">self</span><span class="p">.</span><span class="nx">jar</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_jar</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">jar</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">pathname</span><span class="p">)</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">==</span> <span class="s1">&#39;http:&#39;</span><span class="p">)</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="mi">80</span><span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">==</span> <span class="s1">&#39;https:&#39;</span><span class="p">)</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="mi">443</span><span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">tunnel</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">port</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">hostname</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">port</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">hostname</span>
  <span class="p">}</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">clientErrorHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_aborted</span><span class="p">)</span> <span class="k">return</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">setHost</span><span class="p">)</span> <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">_reusedSocket</span> <span class="o">&amp;&amp;</span> <span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="s1">&#39;ECONNRESET&#39;</span>
        <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">agent</span><span class="p">.</span><span class="nx">addRequestNoreuse</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">agent</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">addRequest</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">agent</span><span class="p">.</span><span class="nx">addRequestNoreuse</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">agent</span><span class="p">)</span> <span class="p">}</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">timeoutTimer</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">timeoutTimer</span><span class="p">)</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">timeoutTimer</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">}</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">form</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">form</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">oauth</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">oauth</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">oauth</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">auth</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span> <span class="o">=</span> <span class="s2">&quot;Basic &quot;</span> <span class="o">+</span> <span class="nx">toBase64</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span> <span class="k">return</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">unescape</span><span class="p">(</span><span class="nx">item</span><span class="p">)}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">))</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">auth</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;proxy-authorization&#39;</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">tunnel</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;proxy-authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Basic &quot;</span> <span class="o">+</span> <span class="nx">toBase64</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span> <span class="k">return</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">unescape</span><span class="p">(</span><span class="nx">item</span><span class="p">)}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">qs</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">qs</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">qs</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">path</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">+</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">search</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">tunnel</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">json</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">multipart</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">multipart</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">multipart</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">length</span> <span class="o">+=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">length</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
        <span class="nx">length</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">length</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">length</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">length</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Argument error, options.body.&#39;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">protocol</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">tunnel</span> <span class="o">?</span> <span class="nx">self</span><span class="p">.</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">protocol</span>
    <span class="p">,</span> <span class="nx">defaultModules</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;http:&#39;</span><span class="o">:</span><span class="nx">http</span><span class="p">,</span> <span class="s1">&#39;https:&#39;</span><span class="o">:</span><span class="nx">https</span><span class="p">}</span>
    <span class="p">,</span> <span class="nx">httpModules</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">httpModules</span> <span class="o">||</span> <span class="p">{}</span>
    <span class="p">;</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">httpModule</span> <span class="o">=</span> <span class="nx">httpModules</span><span class="p">[</span><span class="nx">protocol</span><span class="p">]</span> <span class="o">||</span> <span class="nx">defaultModules</span><span class="p">[</span><span class="nx">protocol</span><span class="p">]</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">httpModule</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid protocol&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">ca</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">ca</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ca</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">agent</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">agentOptions</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">agentOptions</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">agentOptions</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">agentClass</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">agentClass</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">agentClass</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">forever</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">agentClass</span> <span class="o">=</span> <span class="nx">protocol</span> <span class="o">===</span> <span class="s1">&#39;http:&#39;</span> <span class="o">?</span> <span class="nx">ForeverAgent</span> <span class="o">:</span> <span class="nx">ForeverAgent</span><span class="p">.</span><span class="nx">SSL</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">agentClass</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">httpModule</span><span class="p">.</span><span class="nx">Agent</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">pool</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">agent</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">agent</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">agent</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">getAgent</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">maxSockets</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>Don't use our pooling if node has the refactored client</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">agent</span><span class="p">.</span><span class="nx">maxSockets</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">maxSockets</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nx">maxSockets</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Don't use our pooling if node has the refactored client</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">agent</span><span class="p">.</span><span class="nx">maxSockets</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nx">maxSockets</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;pipe&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">ntick</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;You cannot pipe to this stream after the first nextTick() after creation of the request stream.&quot;</span><span class="p">)</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">src</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isReadStream</span><span class="p">(</span><span class="nx">src</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">])</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mimetypes</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">src</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">src</span><span class="p">.</span><span class="nx">method</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">src</span><span class="p">.</span><span class="nx">method</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;pipe&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;You have already piped to this stream. Pipeing twice is likely to break the request.&quot;</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_aborted</span><span class="p">)</span> <span class="k">return</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">part</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">part</span><span class="p">)</span>
        <span class="p">})</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">requestBodyStream</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;options.requestBodyStream is deprecated, please pass the request object to stream.pipe.&quot;</span><span class="p">)</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">requestBodyStream</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">src</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">ntick</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getAgent</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Agent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">agentClass</span>
  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">agentOptions</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">agentOptions</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">agentOptions</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ca</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ca</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ca</span>

  <span class="kd">var</span> <span class="nx">poolKey</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>different types of agents are in different pools</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">Agent</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">httpModule</span><span class="p">.</span><span class="nx">Agent</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">poolKey</span> <span class="o">+=</span> <span class="nx">Agent</span><span class="p">.</span><span class="nx">name</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">httpModule</span><span class="p">.</span><span class="nx">globalAgent</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>node 0.4.x</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">options</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">host</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">poolKey</span><span class="p">)</span> <span class="nx">poolKey</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span>
    <span class="nx">poolKey</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">port</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">ca</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">poolKey</span><span class="p">)</span> <span class="nx">poolKey</span> <span class="o">+=</span> <span class="s1">&#39;:&#39;</span>
    <span class="nx">poolKey</span> <span class="o">+=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">ca</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">poolKey</span> <span class="o">&amp;&amp;</span> <span class="nx">Agent</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">httpModule</span><span class="p">.</span><span class="nx">Agent</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">httpModule</span><span class="p">.</span><span class="nx">globalAgent</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>not doing anything special.  Use the globalAgent</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">httpModule</span><span class="p">.</span><span class="nx">globalAgent</span>
  <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>already generated an agent for this setting</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pool</span><span class="p">[</span><span class="nx">poolKey</span><span class="p">])</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">pool</span><span class="p">[</span><span class="nx">poolKey</span><span class="p">]</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">pool</span><span class="p">[</span><span class="nx">poolKey</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Agent</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_aborted</span><span class="p">)</span> <span class="k">return</span>
  
  <span class="nx">self</span><span class="p">.</span><span class="nx">_started</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">method</span> <span class="o">||</span> <span class="s1">&#39;GET&#39;</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">href</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">log</span><span class="p">)</span> <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;%method %href&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">)</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">req</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">httpModule</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_aborted</span><span class="p">)</span> <span class="k">return</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_paused</span><span class="p">)</span> <span class="nx">response</span><span class="p">.</span><span class="nx">pause</span><span class="p">()</span>
    
    <span class="nx">self</span><span class="p">.</span><span class="nx">response</span> <span class="o">=</span> <span class="nx">response</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">request</span> <span class="o">=</span> <span class="nx">self</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">toJSON</span> <span class="o">=</span> <span class="nx">toJSON</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">httpModule</span> <span class="o">===</span> <span class="nx">https</span> <span class="o">&amp;&amp;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">strictSSL</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="nx">response</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">authorized</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">sslErr</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">authorizationError</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;SSL Error: &#39;</span><span class="o">+</span> <span class="nx">sslErr</span><span class="p">))</span>
      <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">setHost</span><span class="p">)</span> <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">timeoutTimer</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">timeoutTimer</span><span class="p">)</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">timeoutTimer</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="p">}</span>  
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;set-cookie&#39;</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">_disableCookies</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;set-cookie&#39;</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">cookie</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_jar</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_jar</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Cookie</span><span class="p">(</span><span class="nx">cookie</span><span class="p">))</span>
        <span class="k">else</span> <span class="nx">cookieJar</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Cookie</span><span class="p">(</span><span class="nx">cookie</span><span class="p">))</span>
      <span class="p">})</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">&gt;=</span> <span class="mi">300</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">&lt;</span> <span class="mi">400</span>  <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">followAllRedirects</span> <span class="o">||</span>
         <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">followRedirect</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">method</span> <span class="o">!==</span> <span class="s1">&#39;PUT&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">method</span> <span class="o">!==</span> <span class="s1">&#39;POST&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">method</span> <span class="o">!==</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_redirectsFollowed</span> <span class="o">&gt;=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">maxRedirects</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Exceeded maxRedirects. Probably stuck in a redirect loop.&quot;</span><span class="p">))</span>
        <span class="k">return</span>
      <span class="p">}</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">_redirectsFollowed</span> <span class="o">+=</span> <span class="mi">1</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isUrl</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">location</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">href</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">location</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">redirects</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
        <span class="p">{</span> <span class="nx">statusCode</span> <span class="o">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span>
        <span class="p">,</span> <span class="nx">redirectUri</span><span class="o">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">location</span> 
        <span class="p">}</span>
      <span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">followAllRedirects</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>self.method = 'GET'; // Force all redirects to use GET || commented out fixes #215</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">req</span>
      <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">agent</span>
      <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_started</span>
      <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">body</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">log</span><span class="p">)</span> <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Redirect to %uri&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">)</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">init</span><span class="p">()</span>
      <span class="k">return</span> <span class="c1">// Ignore the rest of the response</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">_redirectsFollowed</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_redirectsFollowed</span> <span class="o">||</span> <span class="mi">0</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>Be a good stream and emit end when the response is finished.
Hack to emit end on close because of a core bug that never fires end</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nx">response</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">_ended</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
      <span class="p">})</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">encoding</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dests</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Ingoring encoding parameter as this stream is being piped to another stream which makes the encoding option invalid.&quot;</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">response</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">encoding</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">dests</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">dest</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">pipeDest</span><span class="p">(</span><span class="nx">dest</span><span class="p">)</span>
      <span class="p">})</span>

      <span class="nx">response</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_destdata</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">)</span>
      <span class="p">})</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_ended</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">)</span>
      <span class="p">})</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">)})</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="kd">var</span> <span class="nx">bodyLen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">buffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span>
          <span class="nx">bodyLen</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">length</span>
        <span class="p">})</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_aborted</span><span class="p">)</span> <span class="k">return</span>
          
          <span class="k">if</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">bodyLen</span><span class="p">)</span>
            <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nx">buffer</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">chunk</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
              <span class="nx">i</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">length</span>
            <span class="p">})</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">response</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">body</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">response</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">buffer</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">response</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">buffer</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
          <span class="p">}</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_json</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
              <span class="nx">response</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
          <span class="p">}</span>
          
          <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;complete&#39;</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
        <span class="p">})</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">timeoutTimer</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">timeoutTimer</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
      <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;ETIMEDOUT&quot;</span><span class="p">)</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">=</span> <span class="s2">&quot;ETIMEDOUT&quot;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
    <span class="p">},</span> <span class="nx">self</span><span class="p">.</span><span class="nx">timeout</span><span class="p">)</span>
    </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>Set additional timeout on socket - in case if remote
server freeze after sending headers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// only works on node 0.6+</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">timeout</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
          <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;ESOCKETTIMEDOUT&quot;</span><span class="p">)</span>
          <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">=</span> <span class="s2">&quot;ESOCKETTIMEDOUT&quot;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">})</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="nx">self</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">clientErrorHandler</span><span class="p">)</span>
  
  <span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">req</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">abort</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_aborted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">abort</span><span class="p">()</span>
  <span class="p">}</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;abort&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pipeDest</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">dest</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">response</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>Called after the response is received</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">dest</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">dest</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-length&#39;</span><span class="p">])</span> <span class="p">{</span>
      <span class="nx">dest</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-length&#39;</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">dest</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">dest</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="nx">dest</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pipefilter</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">pipefilter</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">dest</span><span class="p">)</span>
<span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>Composable API</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setHeader</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">clobber</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">clobber</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">clobber</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">clobber</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
  <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nx">value</span>
  <span class="k">return</span> <span class="k">this</span>
<span class="p">}</span>
<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setHeaders</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">headers</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">headers</span><span class="p">)</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">i</span><span class="p">])}</span>
  <span class="k">return</span> <span class="k">this</span>
<span class="p">}</span>
<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">qs</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">q</span><span class="p">,</span> <span class="nx">clobber</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">base</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">clobber</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span> <span class="nx">base</span> <span class="o">=</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span>
  <span class="k">else</span> <span class="nx">base</span> <span class="o">=</span> <span class="p">{}</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">q</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">base</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">q</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
  <span class="p">}</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">base</span><span class="p">))</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span>
  
  <span class="k">return</span> <span class="k">this</span>
<span class="p">}</span>
<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">form</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;application/x-www-form-urlencoded; charset=utf-8&#39;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">form</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="k">this</span>
<span class="p">}</span>
<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">multipart</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">multipart</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;multipart/related; boundary=frontier&#39;</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;; boundary=frontier&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">multipart</span><span class="p">.</span><span class="nx">forEach</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Argument error, options.multipart.&#39;</span><span class="p">)</span>

  <span class="nx">multipart</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">part</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">part</span><span class="p">.</span><span class="nx">body</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">body</span><span class="p">)</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Body attribute missing in multipart.&#39;</span><span class="p">)</span>
    <span class="k">delete</span> <span class="nx">part</span><span class="p">.</span><span class="nx">body</span>
    <span class="kd">var</span> <span class="nx">preamble</span> <span class="o">=</span> <span class="s1">&#39;--frontier\r\n&#39;</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">part</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">){</span>
      <span class="nx">preamble</span> <span class="o">+=</span> <span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">part</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;\r\n&#39;</span>
    <span class="p">})</span>
    <span class="nx">preamble</span> <span class="o">+=</span> <span class="s1">&#39;\r\n&#39;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">preamble</span><span class="p">))</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">body</span><span class="p">))</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="s1">&#39;\r\n&#39;</span><span class="p">))</span>
  <span class="p">})</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="s1">&#39;--frontier--&#39;</span><span class="p">))</span>
  <span class="k">return</span> <span class="nx">self</span>
<span class="p">}</span>
<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">json</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">)</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;accept&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">)</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_json</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">val</span> <span class="o">===</span> <span class="s1">&#39;boolean&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">this</span>
<span class="p">}</span>
<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">oauth</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">_oauth</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">form</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">]</span> <span class="o">&amp;&amp;</span> 
      <span class="k">this</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;content-type&#39;</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">===</span>
        <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span> 
     <span class="p">)</span> <span class="p">{</span>
    <span class="nx">form</span> <span class="o">=</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">form</span> <span class="o">=</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span>
  <span class="p">}</span> 
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">form</span><span class="p">)</span> <span class="nx">form</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="kd">var</span> <span class="nx">oa</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">form</span><span class="p">)</span> <span class="nx">oa</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">form</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">_oauth</span><span class="p">)</span> <span class="nx">oa</span><span class="p">[</span><span class="s1">&#39;oauth_&#39;</span><span class="o">+</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_oauth</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">oa</span><span class="p">.</span><span class="nx">oauth_version</span><span class="p">)</span> <span class="nx">oa</span><span class="p">.</span><span class="nx">oauth_version</span> <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">oa</span><span class="p">.</span><span class="nx">oauth_timestamp</span><span class="p">)</span> <span class="nx">oa</span><span class="p">.</span><span class="nx">oauth_timestamp</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span> <span class="p">).</span><span class="nx">toString</span><span class="p">()</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">oa</span><span class="p">.</span><span class="nx">oauth_nonce</span><span class="p">)</span> <span class="nx">oa</span><span class="p">.</span><span class="nx">oauth_nonce</span> <span class="o">=</span> <span class="nx">uuid</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/-/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
  
  <span class="nx">oa</span><span class="p">.</span><span class="nx">oauth_signature_method</span> <span class="o">=</span> <span class="s1">&#39;HMAC-SHA1&#39;</span>
  
  <span class="kd">var</span> <span class="nx">consumer_secret</span> <span class="o">=</span> <span class="nx">oa</span><span class="p">.</span><span class="nx">oauth_consumer_secret</span>
  <span class="k">delete</span> <span class="nx">oa</span><span class="p">.</span><span class="nx">oauth_consumer_secret</span>
  <span class="kd">var</span> <span class="nx">token_secret</span> <span class="o">=</span> <span class="nx">oa</span><span class="p">.</span><span class="nx">oauth_token_secret</span>
  <span class="k">delete</span> <span class="nx">oa</span><span class="p">.</span><span class="nx">oauth_token_secret</span>
  
  <span class="kd">var</span> <span class="nx">baseurl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">pathname</span>
  <span class="kd">var</span> <span class="nx">signature</span> <span class="o">=</span> <span class="nx">oauth</span><span class="p">.</span><span class="nx">hmacsign</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="nx">baseurl</span><span class="p">,</span> <span class="nx">oa</span><span class="p">,</span> <span class="nx">consumer_secret</span><span class="p">,</span> <span class="nx">token_secret</span><span class="p">)</span>
  </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>oa.oauth_signature = signature</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">form</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">i</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;oauth_&#39;</span><span class="p">)</span> <span class="k">in</span> <span class="nx">_oauth</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>skip </p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">delete</span> <span class="nx">oa</span><span class="p">[</span><span class="s1">&#39;oauth_&#39;</span><span class="o">+</span><span class="nx">i</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">Authorization</span> <span class="o">=</span> 
    <span class="s1">&#39;OAuth &#39;</span><span class="o">+</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">oa</span><span class="p">).</span><span class="nx">sort</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">i</span><span class="o">+</span><span class="s1">&#39;=&quot;&#39;</span><span class="o">+</span><span class="nx">oauth</span><span class="p">.</span><span class="nx">rfc3986</span><span class="p">(</span><span class="nx">oa</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span><span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">Authorization</span> <span class="o">+=</span> <span class="s1">&#39;,oauth_signature=&quot;&#39;</span><span class="o">+</span><span class="nx">oauth</span><span class="p">.</span><span class="nx">rfc3986</span><span class="p">(</span><span class="nx">signature</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span>
  <span class="k">return</span> <span class="k">this</span>
<span class="p">}</span>
<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">jar</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">jar</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">cookies</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_redirectsFollowed</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">originalCookieHeader</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">jar</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>disable cookies</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">cookies</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_disableCookies</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">jar</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>fetch cookie from the user defined cookie jar</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">cookies</span> <span class="o">=</span> <span class="nx">jar</span><span class="p">.</span><span class="nx">get</span><span class="p">({</span> <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">href</span> <span class="p">})</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>fetch cookie from the global cookie jar</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">cookies</span> <span class="o">=</span> <span class="nx">cookieJar</span><span class="p">.</span><span class="nx">get</span><span class="p">({</span> <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">.</span><span class="nx">href</span> <span class="p">})</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="nx">cookies</span> <span class="o">&amp;&amp;</span> <span class="nx">cookies</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cookieString</span> <span class="o">=</span> <span class="nx">cookies</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nx">c</span><span class="p">.</span><span class="nx">value</span>
    <span class="p">}).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">originalCookieHeader</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>Don't overwrite existing Cookie header</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">originalCookieHeader</span> <span class="o">+</span> <span class="s1">&#39;; &#39;</span> <span class="o">+</span> <span class="nx">cookieString</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">cookieString</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_jar</span> <span class="o">=</span> <span class="nx">jar</span>
  <span class="k">return</span> <span class="k">this</span>
<span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>Stream API</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pipe</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">dest</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_destdata</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;You cannot pipe after data has been emitted from the response.&quot;</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_ended</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;You cannot pipe after the response has been ended.&quot;</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">stream</span><span class="p">.</span><span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pipe</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">dest</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">pipeDest</span><span class="p">(</span><span class="nx">dest</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">dest</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dests</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dest</span><span class="p">)</span>
    <span class="nx">stream</span><span class="p">.</span><span class="nx">Stream</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pipe</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">dest</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">dest</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">write</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_started</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">write</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">req</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">end</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_started</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
<span class="p">}</span>
<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pause</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_paused</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">pause</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">resume</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">_paused</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">resume</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_ended</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
<span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>organize params for post, put, head, del</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">initParams</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">((</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">uri</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span><span class="nx">uri</span><span class="o">:</span><span class="nx">uri</span><span class="p">};</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">;</span>
    <span class="nx">uri</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">uri</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">{</span> <span class="nx">uri</span><span class="o">:</span> <span class="nx">uri</span><span class="p">,</span> <span class="nx">options</span><span class="o">:</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="o">:</span> <span class="nx">callback</span> <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">request</span> <span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">uri</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;undefined is not a valid uri or options object.&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">((</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">uri</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span><span class="nx">uri</span><span class="o">:</span><span class="nx">uri</span><span class="p">};</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">callback</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Request</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">r</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">request</span>

<span class="nx">request</span><span class="p">.</span><span class="nx">defaults</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">def</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">initParams</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">opts</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">method</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">callback</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">d</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">de</span> <span class="o">=</span> <span class="nx">def</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span>
  <span class="nx">de</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="nx">def</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">get</span><span class="p">)</span>
  <span class="nx">de</span><span class="p">.</span><span class="nx">post</span> <span class="o">=</span> <span class="nx">def</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">post</span><span class="p">)</span>
  <span class="nx">de</span><span class="p">.</span><span class="nx">put</span> <span class="o">=</span> <span class="nx">def</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">put</span><span class="p">)</span>
  <span class="nx">de</span><span class="p">.</span><span class="nx">head</span> <span class="o">=</span> <span class="nx">def</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">head</span><span class="p">)</span>
  <span class="nx">de</span><span class="p">.</span><span class="nx">del</span> <span class="o">=</span> <span class="nx">def</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">del</span><span class="p">)</span>
  <span class="nx">de</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="nx">def</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">cookie</span><span class="p">)</span>
  <span class="nx">de</span><span class="p">.</span><span class="nx">jar</span> <span class="o">=</span> <span class="nx">def</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">jar</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">de</span>
<span class="p">}</span>

<span class="nx">request</span><span class="p">.</span><span class="nx">forever</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">agentOptions</span><span class="p">,</span> <span class="nx">optionsArg</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">optionsArg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">option</span> <span class="k">in</span> <span class="nx">optionsArg</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span><span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="o">=</span> <span class="nx">optionsArg</span><span class="p">[</span><span class="nx">option</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">agentOptions</span><span class="p">)</span> <span class="nx">options</span><span class="p">.</span><span class="nx">agentOptions</span> <span class="o">=</span> <span class="nx">agentOptions</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">forever</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">request</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="nx">request</span>
<span class="nx">request</span><span class="p">.</span><span class="nx">post</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">initParams</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">uri</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">callback</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">request</span><span class="p">.</span><span class="nx">put</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">initParams</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="s1">&#39;PUT&#39;</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">uri</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">callback</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">request</span><span class="p">.</span><span class="nx">head</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">initParams</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="s1">&#39;HEAD&#39;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">body</span> <span class="o">||</span> 
      <span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">requestBodyStream</span> <span class="o">||</span> 
      <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">json</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">json</span> <span class="o">!==</span> <span class="s1">&#39;boolean&#39;</span><span class="p">)</span> <span class="o">||</span> 
      <span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">multipart</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;HTTP HEAD requests MUST NOT include a request body.&quot;</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">uri</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">callback</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">request</span><span class="p">.</span><span class="nx">del</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="nx">initParams</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
  <span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="s1">&#39;DELETE&#39;</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">uri</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">params</span><span class="p">.</span><span class="nx">callback</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">request</span><span class="p">.</span><span class="nx">jar</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">CookieJar</span>
<span class="p">}</span>
<span class="nx">request</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">str</span> <span class="o">&amp;&amp;</span> <span class="nx">str</span><span class="p">.</span><span class="nx">uri</span><span class="p">)</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">uri</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">str</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;The cookie function only accepts STRING as param&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">Cookie</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
<span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>Safe toJSON</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">getSafe</span> <span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">uuid</span><span class="p">)</span> <span class="p">{</span>  
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">self</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">self</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="kd">var</span> <span class="nx">safe</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">self</span><span class="p">))</span> <span class="kd">var</span> <span class="nx">safe</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="kd">var</span> <span class="nx">recurse</span> <span class="o">=</span> <span class="p">[]</span>
  
  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">uuid</span><span class="p">,</span> <span class="p">{})</span>
  
  <span class="kd">var</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">self</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="nx">uuid</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span> 
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">self</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">self</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">self</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span>
    <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyDescriptor</span><span class="p">(</span><span class="nx">self</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">uuid</span><span class="p">))</span>
  <span class="p">})</span>
  
  
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">self</span><span class="p">[</span><span class="nx">attrs</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">self</span><span class="p">[</span><span class="nx">attrs</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="o">||</span> 
          <span class="nx">self</span><span class="p">[</span><span class="nx">attrs</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">===</span> <span class="kc">null</span>
        <span class="p">)</span> <span class="p">{</span>
      <span class="nx">safe</span><span class="p">[</span><span class="nx">attrs</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">self</span><span class="p">[</span><span class="nx">attrs</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">recurse</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">attrs</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
      <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">self</span><span class="p">[</span><span class="nx">attrs</span><span class="p">[</span><span class="nx">i</span><span class="p">]],</span> <span class="nx">uuid</span><span class="p">,</span> <span class="p">{})</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">recurse</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">safe</span><span class="p">[</span><span class="nx">recurse</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">getSafe</span><span class="p">(</span><span class="nx">self</span><span class="p">[</span><span class="nx">recurse</span><span class="p">[</span><span class="nx">i</span><span class="p">]],</span> <span class="nx">uuid</span><span class="p">)</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="nx">safe</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">toJSON</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">getSafe</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">(((</span><span class="mi">1</span><span class="o">+</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">())</span><span class="o">*</span><span class="mh">0x10000</span><span class="p">)</span><span class="o">|</span><span class="mi">0</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
<span class="p">}</span>

<span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toJSON</span> <span class="o">=</span> <span class="nx">toJSON</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
