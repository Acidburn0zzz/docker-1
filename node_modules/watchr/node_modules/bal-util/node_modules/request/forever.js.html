<!DOCTYPE html>
<html>
<head>
  <title>forever.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../../../../doc-style.css" />
  <script src="../../../../../../doc-filelist.js"></script>
  <script>
    var relativeDir = '../../../../../../', thisFile = 'node_modules/watchr/node_modules/bal-util/node_modules/request/forever.js';
  </script>
  <script src="../../../../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>forever.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">ForeverAgent</span>
<span class="nx">ForeverAgent</span><span class="p">.</span><span class="nx">SSL</span> <span class="o">=</span> <span class="nx">ForeverAgentSSL</span>

<span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">Agent</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">).</span><span class="nx">Agent</span>
  <span class="p">,</span> <span class="nx">net</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;net&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">tls</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;tls&#39;</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">AgentSSL</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">).</span><span class="nx">Agent</span>

<span class="kd">function</span> <span class="nx">ForeverAgent</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{}</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">requests</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">sockets</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">freeSockets</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">maxSockets</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">maxSockets</span> <span class="o">||</span> <span class="nx">Agent</span><span class="p">.</span><span class="nx">defaultMaxSockets</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">minSockets</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">minSockets</span> <span class="o">||</span> <span class="nx">ForeverAgent</span><span class="p">.</span><span class="nx">defaultMinSockets</span>
  <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;free&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">host</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">port</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">shift</span><span class="p">().</span><span class="nx">onSocket</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">sockets</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">minSockets</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">freeSockets</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="nx">self</span><span class="p">.</span><span class="nx">freeSockets</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">freeSockets</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span>
      </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>if an error happens while we don't use the socket anyway, meh, throw the socket away</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="kd">function</span> <span class="nx">onIdleError</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span>
      <span class="p">}</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">_onIdleError</span> <span class="o">=</span> <span class="nx">onIdleError</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">onIdleError</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>If there are no pending requests just destroy the
socket and it will get removed from the pool. This
gets us out of timeout issues and allows us to
default to Connection:keep-alive.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nx">socket</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">})</span>

<span class="p">}</span>
<span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">ForeverAgent</span><span class="p">,</span> <span class="nx">Agent</span><span class="p">)</span>

<span class="nx">ForeverAgent</span><span class="p">.</span><span class="nx">defaultMinSockets</span> <span class="o">=</span> <span class="mi">5</span>


<span class="nx">ForeverAgent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createConnection</span> <span class="o">=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">createConnection</span>
<span class="nx">ForeverAgent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addRequestNoreuse</span> <span class="o">=</span> <span class="nx">Agent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addRequest</span>
<span class="nx">ForeverAgent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addRequest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">host</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">port</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">freeSockets</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">freeSockets</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">useChunkedEncodingByDefault</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">idleSocket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">freeSockets</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">pop</span><span class="p">()</span>
    <span class="nx">idleSocket</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">idleSocket</span><span class="p">.</span><span class="nx">_onIdleError</span><span class="p">)</span>
    <span class="k">delete</span> <span class="nx">idleSocket</span><span class="p">.</span><span class="nx">_onIdleError</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">_reusedSocket</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">onSocket</span><span class="p">(</span><span class="nx">idleSocket</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">addRequestNoreuse</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">ForeverAgent</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeSocket</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sockets</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sockets</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">sockets</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sockets</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">sockets</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>don't leak</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">sockets</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">freeSockets</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">freeSockets</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">freeSockets</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">freeSockets</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">freeSockets</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>If we have pending requests and a socket gets closed a new one
needs to be created to take over in the pool for the one that closed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">this</span><span class="p">.</span><span class="nx">createSocket</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;free&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">ForeverAgentSSL</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">ForeverAgent</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">util</span><span class="p">.</span><span class="nx">inherits</span><span class="p">(</span><span class="nx">ForeverAgentSSL</span><span class="p">,</span> <span class="nx">ForeverAgent</span><span class="p">)</span>

<span class="nx">ForeverAgentSSL</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createConnection</span> <span class="o">=</span> <span class="nx">createConnectionSSL</span>
<span class="nx">ForeverAgentSSL</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addRequestNoreuse</span> <span class="o">=</span> <span class="nx">AgentSSL</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addRequest</span>

<span class="kd">function</span> <span class="nx">createConnectionSSL</span> <span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nx">port</span>
  <span class="nx">options</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">host</span>
  <span class="k">return</span> <span class="nx">tls</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
